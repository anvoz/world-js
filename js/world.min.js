/*!
 * World JS: Evolution Simulator
 * https://github.com/anvoz/world-js
 *
 * Include:
 * World JS Core Library 1.0
 * World JS Knowledge List 1.0
 * World JS Front View 1.0
 *
 * Copyright (c) 2013 An Vo - anvo4888@gmail.com
 * Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 */
(function(e,t){"use strict";function i(e,t){return typeof e===t}function s(e,t){return e.hasOwnProperty(t)}function o(e,t){return Math.floor(Math.random()*(t-e+1)+e)}var n=e.document,r=function(){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){e.setTimeout(t,1e3/50)}}();var u=e.WorldJS=function(){var e=this;e.running=false;e.stopCallback=function(){};e.width=640;e.height=360;e.padding=10;e.canvas={wrapper:false,context:false};e.sprite={src:"images/seeds.png",image:false};e.nextSeedId=1;e.seeds={};e.maxSafeSeedsForDisplay=1e3;e.tickPerYear=50;e.tickMod=-1;e.Tile={list:[],size:20,maxDisplayedSeeds:10,totalTiles:false,tilesPerRow:false,tilesPerCol:false,getIndex:function(e){return Math.floor(e.x/this.size)+Math.floor(e.y/this.size)*this.tilesPerRow},set:function(e){this.list[e.tileIndex][e.id]=e},rem:function(e){delete this.list[e.tileIndex][e.id]}};e.Statistic={year:0,food:1e4,population:0,male:0,female:0,IQ:0,family:0,men:0,women:0,boy:0,girl:0,maxIQ:0,yearMaxIQ:0,maxAge:0,yearMaxAge:0,die:0,sumAge:0,dieMarriedFemale:0,sumChildren:0};e.Rules={baseIQ:0,Chance:{death:0,marriage:0,childbirth:0},ChanceIncr:{death:0,marriage:0,childbirth:0},Food:{adult:-2,child:-1,min:-2e3},Famine:{deathChanceIncr:.5,childbirthChanceIncr:-.5,unit:-1e3},FoodSpoilage:{foodDecr:.9,interval:10}};e.Knowledge={list:{},trending:[],trendingAdded:function(e){},trendingRemoved:function(e){},completed:[],gain:function(e){var t=this,n=e.Statistic.year,r=e.Statistic.IQ,i=[],s=0;for(var u=0,a=t.trending.length;u<=a;u++){i[u]=o(0,100);if(u<a){var f=t.list[t.trending[u]];if(f.IQ.priority!=1){i[u]*=f.IQ.priority}}s+=i[u]}var l=[],c=[],h=[];for(var u=0,a=t.trending.length;u<a;u++){var f=t.list[t.trending[u]],p=r*i[u]/s,d=Math.floor(f.IQ.gained+p);if(d>=f.IQ.required){f.IQ.gained=f.IQ.required;c.push.apply(c,f.following);f.affectedYear=n;f.onAffected(e);h.push(f)}else{f.IQ.gained=d;l.push(f.id)}}if(h.length>0){for(var u=0;u<h.length;u++){t.trendingRemoved(h[u]);t.completed.push(h[u])}for(var u=0;u<c.length;u++){t.trendingAdded(t.list[c[u]]);l.push(c[u])}t.trending=l}}};e.eachYearCallback=function(){}};u.prototype.setEachYearCallback=function(e){var t=this;t.eachYearCallback=e;return t};u.prototype.init=function(e){var t=this;var r=n.createElement("canvas"),i=t.canvas.wrapper=n.getElementById(e),s=t.width=r.width=i.clientWidth||t.width,o=t.height=r.height=i.clientHeight||t.height;i.appendChild(r);t.canvas.context=r.getContext("2d");var u=new Image;u.src=t.sprite.src;t.sprite.image=u;var a=t.Tile,f=a.size,l=Math.ceil(s/f)*Math.ceil(o/f);a.totalTiles=l;a.tilesPerRow=Math.ceil(s/f);a.tilesPerCol=Math.ceil(o/f);var c=a.list;for(var h=0;h<l;h++){c.push({})}return t};u.prototype.add=function(e,t){var n=this,r=new e(t);r.world=n;r.id=n.nextSeedId++;n.seeds[r.id]=r;r.IQ+=n.Rules.baseIQ;if(r.x===false){r.x=o(0,n.width-1-Math.max(r.appearance.width,n.padding))}if(r.y===false){r.y=o(0,n.height-1-r.appearance.height-n.padding)}r.tileIndex=n.Tile.getIndex(r);n.Tile.set(r);var i=n.Statistic;i.population++;if(r instanceof n.Male){i.male++}else{i.female++}var s=r.IQ;i.IQ+=s;if(s>i.maxIQ){i.maxIQ=s;i.yearMaxIQ=i.year}return n};u.prototype.remove=function(e){var t=this;if(e.married){e.married=false;e.relationSeed.married=false;e.relationSeed.relationSeed=false;e.relationSeed=false;t.Statistic.family--}delete t.seeds[e.id];t.Tile.rem(e);var n=t.Statistic;n.population--;if(e instanceof t.Male){n.male--}else{n.female--}n.die++;n.IQ-=e.IQ;var r=e.age;if(r>n.maxAge){n.maxAge=r;n.yearMaxAge=n.year}n.sumAge+=r;if(!i(e.totalChildren,"undefined")){n.dieMarriedFemale++;n.sumChildren+=e.totalChildren}return t};u.prototype.addRandomPeople=function(e,t,n){var r=this,t=i(t,"undefined")?15:t,n=i(n,"undefined")?20:n,s=r.tickPerYear;for(var u=0;u<e;u++){var a=o(t,n),f={tickCount:a*s};if(u<e/2){r.add(r.Male,f)}else{r.add(r.Female,f)}}return r};u.prototype.run=function(){var e=this,t=e.Statistic;e.tickMod=++e.tickMod%e.tickPerYear;var n=t.population<=e.maxSafeSeedsForDisplay||e.tickMod===0;if(n){e.canvas.context.clearRect(0,0,e.width,e.height)}var i=e.Tile.list,o=e.Tile.maxDisplayedSeeds,u=0,a=0;for(var f=0,l=i.length;f<l;f++){var c=i[f],h=0;for(var p in c){if(s(c,p)){var d=c[p],v=d.tileIndex;d.age=d.getAge();if(n){if(h<o){d.draw();h++}}d.tick();var m=e.Tile.getIndex(d);if(m!==v){e.Tile.rem(d);d.tileIndex=m;e.Tile.set(d)}if(e.tickMod===0){if(d.age<=d.maxChildAge){if(d instanceof e.Male){u++}else{a++}}}}}}if(e.tickMod===0){t.year++;t.men=t.male-u;t.women=t.female-a;t.boy=u;t.girl=a;e.change();setTimeout(function(){e.eachYearCallback.call(e)},1);if(t.population===0){e.running=false;return}}if(e.running){r(e.run.bind(e))}else{e.stopCallback.call(e);e.stopCallback=function(){}}return e};u.prototype.start=function(){this.running=true;this.run()};u.prototype.stop=function(e){this.running=false;if(!i(e,"undefined")){this.stopCallback=e}};u.prototype.change=function(){var e=this,t=e.Rules,n=e.Statistic,r=n.food,i=0,s=0;var o=n.boy+n.girl,u=n.population-o;r+=u*t.Food.adult+o*t.Food.child;if(r<t.Food.min){r=t.Food.min}if(r<=t.Famine.unit){var a=Math.floor(r/t.Famine.unit);i+=a*t.Famine.deathChanceIncr;s+=a*t.Famine.childbirthChanceIncr}if(n.year%t.FoodSpoilage.interval===0&&r>0){r-=Math.round(r*t.FoodSpoilage.foodDecr)}n.food=r;t.Chance.death=i+t.ChanceIncr.death;t.Chance.childbirth=s+t.ChanceIncr.childbirth;e.Knowledge.gain(e)};var a=u.prototype.Seed=function(e){var t=this;t.world=false;t.id=false;t.tileIndex=false;t.x=i(e.x,"undefined")?false:e.x;t.y=i(e.y,"undefined")?false:e.y;t.appearance=e.appearance||false;t.relationSeed=e.relationSeed||false;t.tickCount=(e.tickCount||0)+o(0,50);t.actionInterval=e.actionInterval||20;t.moveTo=e.moveTo||false};a.prototype.getAge=function(){var e=this;e.age=Math.ceil(e.tickCount/e.world.tickPerYear);return e.age};a.prototype.draw=function(){var e=this,t=e.world.canvas.context;if(e.appearance===false){t.fillRect(e.x,e.y,10,10)}else{var n;if(!i(e.appearance.child,"undefined")&&e.age<=e.maxChildAge){n=e.appearance.child}else{n=e.appearance}var r=20,s=e.tickCount%r,o=Math.ceil(r/2),u=s<o?s+1:o-s%o-1;t.drawImage(e.world.sprite.image,n.x,n.y,n.width,n.height,e.x,e.y-u,n.width,n.height)}};a.prototype.move=function(e){var t=this;if(!i(e,"function")){if(t.moveTo===false||t.moveTo.x===t.x&&t.moveTo.y===t.y){var n=t.world;t.moveTo={x:o(0,n.width-1-Math.max(t.appearance.width,n.padding)),y:o(n.padding,n.height-1-t.appearance.height-n.padding)}}}else{e.call(t)}if(t.x<t.moveTo.x){t.x++}else if(t.x>t.moveTo.x){t.x--}if(t.y<t.moveTo.y){t.y++}else if(t.y>t.moveTo.y){t.y--}};a.prototype.seek=function(e){var t=this,n=t.world.Tile,r=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];if(!i(e,"function")){e=function(e){return e.id!=t.id}}var o=n.tilesPerRow,u=n.tilesPerCol;for(var a=0,f=r.length;a<f;a++){var l;if(a===0){l=t.tileIndex}else{var c=t.tileIndex%o+r[a][0],h=Math.floor(t.tileIndex/o)+r[a][1];if(c>=0&&c<o&&h>=0&&h<u){l=c+h*o}else{continue}}var p=n.list[l];for(var d in p){if(s(p,d)&&t.id!=d){var v=p[d];if(e.call(t,v)){return v}}}}return false};a.prototype.tick=function(){var e=this;e.tickCount++;e.move()};a.prototype.getChance=function(e,t){var n=e.world,r=e.chances[t],s=e.age;var o=0,u=0,a=0,f=0;while(!i(r[o],"undefined")&&s>r[o].range[0]){var l=r[o];u=l.range[0];a=l.from;f=(l.to-l.from)/(l.range[1]-l.range[0]);o++}var c=a+(s-u)*f;if(n.Rules.Chance[t]!=0){c+=c*n.Rules.Chance[t]}return c};var f=u.prototype.Male=function(e){var t=this;e.appearance={x:0,y:0,width:13,height:20,child:{x:26,y:0,width:11,height:10}};a.call(t,e);t.IQ=(e.IQ||0)+o(0,5);t.age=0;t.maxChildAge=15;t.married=false;t.chances={death:[{range:[1,5],from:.001,to:.005},{range:[5,15],from:.005,to:.01},{range:[15,25],from:.01,to:.05}],marriage:[{range:[15,30],from:.1,to:.5},{range:[30,50],from:.5,to:.1},{range:[50,80],from:.1,to:.01}]}};f.prototype=Object.create(a.prototype);f.prototype.contructor=f;f.prototype.tick=function(){var e=this;e.tickCount++;var n=e.actionInterval;if(e.tickCount%n===n-1){var r=e.world,s=e.age;var o=e.getChance(e,"death");if(o>0&&Math.random()<o){r.remove(e)}if(!e.married){var u=e.getChance(e,"marriage");if(u>0){var a=Math.random();if(a<u){var f=e.seek(function(t){return t instanceof r.Female&&!t.married&&t.age>=15&&(t.age<=e.age||a*Math.ceil((t.age-e.age)/10)<u)});if(f!==false){e.married=true;f.married=true;if(i(f.totalChildren,"undefined")){f.totalChildren=0}e.relationSeed=f;f.relationSeed=e;r.Statistic.family++}}}}}else{var l=!e.married?t:function(){var e=this;var t=e.relationSeed;e.moveTo.x=Math.max(0,t.x-10);e.moveTo.y=t.y};e.move(l)}};var l=u.prototype.Female=function(e){var n=this;e.appearance={x:13,y:0,width:13,height:20,child:{x:26,y:10,width:11,height:10}};a.call(n,e);n.IQ=(e.IQ||0)+o(0,5);n.age=0;n.maxChildAge=15;n.married=false;n.totalChildren=t;n.ageLastBear=0;n.chances={death:[{range:[1,5],from:.001,to:.005},{range:[5,20],from:.005,to:.01},{range:[20,30],from:.01,to:.05}],childbirth:[{range:[15,25],from:.1,to:.25},{range:[25,50],from:.25,to:.1},{range:[50,70],from:.1,to:.001}]}};l.prototype=Object.create(a.prototype);l.prototype.contructor=l;l.prototype.tick=function(){var e=this;e.tickCount++;var t=e.actionInterval;if(e.tickCount%t===t-1){var n=e.world,r=e.age;var i=e.getChance(e,"death");if(i>0&&Math.random()<i){n.remove(e)}if(e.married&&e.ageLastBear<r){var s=e.getChance(e,"childbirth");if(s>0&&Math.random()<s){e.ageLastBear=r;e.totalChildren++;var o={x:e.x,y:Math.min(n.height-1-n.padding,e.y+Math.floor(e.appearance.height/2)),IQ:Math.round((e.relationSeed.IQ+e.IQ)/2)};if(Math.random()<.5){n.add(n.Male,o)}else{n.add(n.Female,o)}}}}else{e.move()}}})(window);
var WorldJSKnowledge={huga:{id:"huga",name:"Hunting and Gathering",description:"Living from edible plants and animals from the wild<ul><li>Adult +1 food / year</li></ul>",IQ:{priority:1,gained:0,required:500},following:["crop","cabr"],affectedYear:false,onAffected:function(e){e.Rules.Food.adult+=1}},crop:{id:"crop",name:"Plant crops",description:"Start agriculture by planting a few crops<ul><li>Adult +1 food / year</li></ul>",IQ:{priority:1,gained:0,required:2e3},following:["agri"],affectedYear:false,onAffected:function(e){e.Rules.Food.adult+=1}},cabr:{id:"cabr",name:"Cattle-breeding",description:"Domesticating animals to reduce the need of hunting wild animals for food<ul><li>Adult +1 food / year</li><li>Death rate -10%</li></ul>",IQ:{priority:1,gained:0,required:3e3},following:[],affectedYear:false,onAffected:function(e){e.Rules.Food.adult+=1;e.Rules.ChanceIncr.death-=.1}},agri:{id:"agri",name:"Agriculture",description:"Developing techniques to produce a large amount of food<ul><li>Adult +2 food / year</li><li>Food spoilage -20%</li></ul>",IQ:{priority:1,gained:0,required:5e3},following:[],affectedYear:false,onAffected:function(e){e.Rules.Food.adult+=2;e.Rules.FoodSpoilage.foodDecr-=.2}},fire:{id:"fire",name:"Control of fire",description:"Using fire for warmth and cooking<ul><li>Death rate -10%</li></ul>",IQ:{priority:1,gained:0,required:1e3},following:["writ"],affectedYear:false,onAffected:function(e){e.Rules.ChanceIncr.death-=.1}},writ:{id:"writ",name:"Writing",description:"Inventing symbols that stood for things<ul><li>Base IQ +1</li><li>Child -1 food per year</li></ul>",IQ:{priority:1,gained:0,required:2e4},following:["coso"],affectedYear:false,onAffected:function(e){e.Rules.baseIQ+=1;e.Rules.Food.child-=1}},coso:{id:"coso",name:"Coming soon...",description:'<br /><span class="label label-important">tl;dr</span> In the next update you will have the ability to expand the population beyond 7 billion and manage their knowledge to choose the fate of the world.<hr />'+"Without any knowledge to be gained, the world will meet its apocalypse. Thus evolutions are needed in order for the world to progress and maintain its stability.<br /><br />"+"This is the idea behind <b>World JS: Evolution Simulator</b>. "+"Hope you could understand its idea so far and contribute for its growth.<br /><br />"+"There are 10 types of people who can contribute to this open source project:<br />"+"<ul>"+'<li>For those who understand binary: <a target="_blank" href="https://github.com/anvoz/world-js">Fork me on Github</a>.</li>'+'<li>For those who don\'t: Make your own knowledge list. See example in <a href="#" onclick="$(\'#knowledge a[rel=history]\').click(); return false;">knowledge history</a>.</li>'+"</ul>"+'For any feedback or ideas, email me at <a href="mailto: anvo4888@gmail.com">anvo4888@gmail.com</a>',IQ:{priority:1,gained:0,required:2147483647},following:[],affectedYear:false,onAffected:function(e){}}};
(function(e,t,n){"use strict";var r=e.WorldJS,i=e.WorldJSKnowledge,s=new r;var o={Statistic:{props:["year","population","food","men","women","family","boy","girl","IQ","maxIQ","yearMaxIQ","maxAge","yearMaxAge","avgIQ","avgAge","avgChildren"],elements:{}},Rules:{props:["adultFoodChange","childFoodChange","foodSpoilage"],elements:{}},Knowledge:{props:["knowledgeTrending","knowledgeHistory"],elements:{}}};for(var u in o){if(o.hasOwnProperty(u)){var a=o[u],f=a.props;for(var l=0,c=f.length;l<c;l++){var h=f[l];a.elements[h]={container:t("#world-"+h),value:0}}}}o.Elements={};o.Elements.labelFamine={container:t("#world-labelFamine"),value:false};o.set=function(e,t){if(t!=e.value){e.value=t;e.container.html(t)}};t("#knowledge .header a").each(function(){t(this).click(function(){var e=t(this).attr("rel");t(this).addClass("label").siblings("a").removeClass("label");if(e==="trending"){o.Knowledge.elements.knowledgeTrending.container.removeClass("hide");o.Knowledge.elements.knowledgeHistory.container.addClass("hide")}else{o.Knowledge.elements.knowledgeTrending.container.addClass("hide");o.Knowledge.elements.knowledgeHistory.container.removeClass("hide")}return false})});s.Knowledge.list=i;var p=function(e){var n="world-knowledge-"+e.id,r=['<div id="world-knowledge-',e.id,'" class="knowledge clearfix">','<div class="pull-right btn-group knowledgePriority">','<a class="btn btn-mini" href="#" title="forbid" onclick="return WorldJSGod.setKnowledgePriority(this, \'',e.id,"', 0.1);\">∨</a>",'<a class="btn btn-mini active" href="#" title="free" onclick="return WorldJSGod.setKnowledgePriority(this, \'',e.id,"', 1);\">•</a>",'<a class="btn btn-mini" href="#" title="encourage" onclick="return WorldJSGod.setKnowledgePriority(this, \'',e.id,"', 2);\">∧</a>","</div>",'<div class="name">+ ',e.name,"</div>",'<div class="description">',e.description,"</div>",'<div class="progress progress-info"><div class="bar"></div></div>','<div class="IQ"><span class="world-IQ">0</span> / ',e.IQ.required," IQ</div>","</div>"],i=o.Knowledge.elements;i.knowledgeTrending.container.append(r.join(""));var s=t("#"+n);i[e.id]={container:s,IQContainer:s.find(".world-IQ"),barContainer:s.find(".bar")}};s.Knowledge.trending=["huga","fire"];p(s.Knowledge.list.huga);p(s.Knowledge.list.fire);s.Knowledge.trendingAdded=p;s.Knowledge.trendingRemoved=function(e){var t=o.Knowledge.elements[e.id];t.IQContainer.html(e.IQ.required);t.barContainer.width("100%");t.container.remove();delete o.Knowledge.elements[e.id];var n=['<div class="knowledge">','<div class="name">',s.Statistic.year,": ",e.name,"</div>",'<div class="description">',e.description,"</div>","</div>"];o.Knowledge.elements.knowledgeHistory.container.prepend(n.join(""))};s.init("world").addRandomPeople(100).setEachYearCallback(function(){var e,t;var n=this.Statistic,r=o.Statistic;for(e=0,f=r.props,t=f.length-3;e<t;e++){var i=f[e];o.set(r.elements[i],n[i])}o.set(r.elements.avgIQ,Math.round(n.IQ/n.population));o.set(r.elements.avgAge,Math.round(n.sumAge/n.die));o.set(r.elements.avgChildren,Math.round(n.sumChildren/n.dieMarriedFemale));var s=this.Rules,u=o.Rules;o.set(u.elements.adultFoodChange,s.Food.adult);o.set(u.elements.childFoodChange,s.Food.child);o.set(u.elements.foodSpoilage,s.FoodSpoilage.foodDecr*100);var a=this.Knowledge;for(e=0,t=a.trending.length;e<t;e++){var l=a.list[a.trending[e]],c=o.Knowledge.elements[l.id];c.IQContainer.html(l.IQ.gained);c.barContainer.width(Math.round(l.IQ.gained/l.IQ.required*100)+"%")}var h=o.Elements.labelFamine,p=n.food<=s.Famine.unit;if(p!=h.value){h.value=p;if(p){h.container.removeClass("hide")}else{h.container.addClass("hide")}}}).start();var d=e.WorldJSGod={run:function(){var e=t("#world-run-btn");if(s.running){s.stop();e.html("Unfreeze")}else{s.start();e.html("Freeze")}return false},setKnowledgePriority:function(e,n,r){s.Knowledge.list[n].IQ.priority=r;var i;if(r>1){i="progress"}else if(r<1){i="progress progress-danger"}else{i="progress progress-info"}t(e).addClass("active").siblings().removeClass("active").parent().parent().find(".progress").attr("class",i);return false},addRandomPeople:function(e){var n=s.Statistic.population==0;s.addRandomPeople(e);if(n||!s.running){s.start();t("#world-run-btn").html("Freeze")}return false},kill:function(e){if(!s.running){s.start()}s.stop(function(){var n=s.seeds,r=Math.random,i=e/100;for(var o in n){if(n.hasOwnProperty(o)&&r()<i){s.remove(n[o])}}s.start();t("#world-run-btn").html("Freeze")});return false},giveFood:function(e){s.Statistic.food+=e;return false}}})(window,$,WorldJS);